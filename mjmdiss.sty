%% mjmdiss.sty %%
%% Style file for the dissertation.

\ProvidesPackage{mjmdiss}

% misc. TeX settings
% ------------------
\widowpenalty=10000
\clubpenalty=10000
\setlength{\parindent}{0pt}
% \setlength{\parskip}{6pt plus 2pt minus 1pt}
% \setlength{\emergencystretch}{3em}  % prevent overfull lines
% \setcounter{secnumdepth}{0}
\usepackage{xspace}

% page layout
% -----------
\usepackage[margin=1in,headheight=.5in]{geometry}

\usepackage{setspace}
\doublespacing
\raggedright
\parindent=2em

% bibliography
% ------------
\usepackage[
  backend=biber,
  citereset=chapter,
  notes,
  parentracker=true
]{biblatex-chicago}

% footnotes
% ------------
\usepackage{sepfootnotes}
\newfootnotes{f}
\newcommand{\fn}{\fnote}
\newcommand{\fntext}{\fnotecontent}

% blank footnote comments
\newcommand\blankfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{\hspace{-2.55em}#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

\usepackage[ragged, bottom, splitrule]{footmisc}
\setlength{\skip\footins}{12pt}


% fonts
% -----------
\usepackage{amssymb,amsmath}
\usepackage{fixltx2e} % provides \textsubscript

\usepackage{mathspec}
\usepackage{xltxtra,xunicode}
\defaultfontfeatures{%
  Mapping=tex-text,%
  Scale=MatchUppercase,
  SmallCapsFeatures={
    LetterSpace=5.0,
    Letters = SmallCaps
  }
}

\setmainfont[Numbers={OldStyle}]{Junicode}
\setmathfont(Digits){Junicode}
\setmathsfont(Latin){Junicode}
\setmathrm{Junicode}
\setmathsfont(Symbols){XITS Math}
\fontsize{12pt}{12pt}

\newfontfamily\liningNums{Junicode}
\newfontfamily\sscaptionfont[
    Numbers=OldStyle,
    SmallCapsFeatures={LetterSpace=3.0},
]{Source Sans Pro}
\newfontfamily\ssliningfont[Numbers=Proportional]{Source Sans Pro}

\newfontface\abbrevSC[Letters=UppercaseSmallCaps,LetterSpace=5.0]{Junicode}

% Use non-superscript number for footnotes
\renewcommand{\@makefntext}[1]{%
  \parindent1em \noindent
  \hspace{\footnotemargin}{\normalfont \@thefnmark.~}%
  \footnotelayout#1%
}

\usepackage{subscript}    % for \textsubscript
\usepackage{paralist}
\newcommand{\degree}{\ensuremath{^\circ}}

\usepackage[
  leftmargin = 2em,
  rightmargin = 2em,
  vskip = \partopsep
]{quoting}

% section headings
% ----------------
\usepackage{titling}
\usepackage{titlesec}
\titleformat{\chapter}[display]{%
  \normalfont\large\scshape}
  {\chaptertitlename\ \thechapter}{0pt}{\vspace{-2ex}\LARGE\upshape}{}
\titlespacing*{\chapter}{0pt}{0pt}{1em}

\titleformat*{\section}{\large}
\titleformat*{\subsection}{\normalsize\scshape}

\usepackage[titletoc]{appendix}
\usepackage{tocloft}
\renewcommand{\@dotsep}{2}
%\renewcommand{\cftchapafterpnum}{\vspace{8pt}}

\setlength{\cftbeforetoctitleskip}{0pt}
\setlength{\cftbeforeloftitleskip}{0pt}
\setlength{\cftbeforelottitleskip}{0pt}
\renewcommand{\cfttoctitlefont}{\Large}
\renewcommand{\cftloftitlefont}{\Large}
\renewcommand{\cftlottitlefont}{\Large}

\renewcommand{\@tocrmarg}{2em plus1fil}
\newcommand{\addtocspace}{\addtocontents{toc}{\vspace{8pt}}}

% add chapter divisions in list of figures
\newcommand{\addtolof}[2][lof]{%
  \addtocontents{#1}{%
    \noindent \textbf{\thechapter \quad \nameref{#2}}%
    \vspace{8pt}%
  }%
}

% command for dot-filling the manual TOC for transcriptions
\newcommand{\DottedPage}[1]{%
  \leavevmode \leaders \hb@xt@ .66em{\hss .\hss }\hfill \kern \z@%
  \makebox[1.5em][r]{\pageref{#1}}%
}

% page header
% -----------
\usepackage{fancyhdr}
\pagestyle{fancy}
% \setlength{\headheight}{14pt}

\lhead{}
\chead{}
\rhead{\tiny{\today\ \currenttime}}
\lfoot{}
\cfoot{\thepage}
\rfoot{}
\renewcommand{\headrulewidth}{0pt}

% hyperref
% --------
% (Provides PDF table of contents)
\usepackage[
    unicode,
    bookmarks,
    bookmarksnumbered,
    hidelinks,
    pdfencoding=auto,
    hyperfootnotes=false,
    linktocpage]{hyperref}
\urlstyle{same}

% examples/captions
% -----------------
\usepackage{newfloat}
\DeclareFloatingEnvironment[
  name={Example},
  placement=htbp
]{example}

\usepackage[section]{placeins}
\usepackage{float}
\usepackage{pdfpages}

% provide opts to includegraphics as optional arg
\newcommand{\centerGraphic}[2][]{%
  \begin{center}%
    \includegraphics[#1]{#2}%
  \end{center}%
}


\usepackage{caption}
\DeclareCaptionFont{sansserif}{\sscaptionfont\footnotesize}
\captionsetup{
  format = plain,
  labelsep = period,
  font=sansserif,
  margin=2em,
  justification = raggedright,
  singlelinecheck = false,
}
% work continued floats properly
\renewcommand\theContinuedFloat{\alph{ContinuedFloat}}


\usepackage{marginnote}
\newcommand{\sidenote}[1]{\marginnote{\singlespacing\footnotesize#1}}

% misc. formatting
% ----------------
\usepackage{datetime}
\yyyymmdddate
\renewcommand{\dateseparator}{-}
\usepackage[chicago]{ellipsis}      % better spaced ellipses

% command for removing extra vertical space in math envs
\newcommand{\novspace}{%
    \setlength{\abovedisplayskip}{.5em plus 3pt minus 3pt}%
    \setlength{\belowdisplayskip}{.5em plus 3pt minus 3pt}%
}

% proposal-specific
% -----------------

% scale degrees /music stuff
\newcommand{\sd}[1]{\ensuremath{\hat{#1}}}
\renewcommand{\flat}{{\fontspec[Scale=1.05]{Times + Musical}f}}
\renewcommand{\sharp}{{\fontspec[Scale=1.05]{Times + Musical}s}}
\newcommand{\nat}{{\fontspec[Scale=1.05]{Times + Musical}n}}

% kerning on these characters sucks, so define some kern lengths
\newcommand{\fklen}{0.5pt}
\newcommand{\sklen}{0.4pt}
\newcommand{\flatkern}{\hspace{\fklen}}
\newcommand{\sharpkern}{\hspace{\sklen}}

\newcommand{\Bflat}{\mbox{B\flatkern\flat\sharpkern}\xspace}
\newcommand{\Eflat}{\mbox{E\flatkern\flat\sharpkern}\xspace}
\newcommand{\Aflat}{\mbox{A\flatkern\flat\sharpkern}\xspace}
\newcommand{\Dflat}{\mbox{D\flatkern\flat\sharpkern}\xspace}
\newcommand{\Gflat}{\mbox{G\flatkern\flat\sharpkern}\xspace}
\newcommand{\Cflat}{\mbox{C\flatkern\flat\sharpkern}\xspace}
\newcommand{\Fflat}{\mbox{F\flatkern\flat\sharpkern}\xspace}

% Define a new command, \h, that prints a harmony.
% It substitutes all 's' chars with sharps, and all 'b' chars with flats.
% Also adds some padding before the special chars and wraps them in an mbox{}
% so that they don't get split across lines
%
% Ex: \h{Fsm7b5} --> \mbox{F\hspace{1.25pt}\sharp{}m7\hspace{1.25pt}\flat{}5}
\usepackage{xstring}
\newcommand{\h}[1]{%
  {%
    \liningNums%
  \mbox{%
    \StrSubstitute{#1}{s}{\sharp{}}[\x]%
    \StrSubstitute{\x}{b}{\flat{}}[\x]%
    \StrSubstitute{\x}{o}{\degree{}}[\x]%
    \expandarg%
    \StrSubstitute{\x}{\flat}{\hspace{\fklen}\flat}[\x]%
    \StrSubstitute{\x}{\sharp}{\hspace{\sklen}\sharp}[\x]%
    \x%
  }%
  }%
}

% caption harmony
\newcommand{\caph}[1]{%
  {%
    \ssliningfont%
  \mbox{%
    \StrSubstitute{#1}{s}{\sharp{}}[\x]%
    \StrSubstitute{\x}{b}{\flat{}}[\x]%
    \StrSubstitute{\x}{o}{\degree{}}[\x]%
    \expandarg%
    \StrSubstitute{\x}{\flat}{\hspace{\fklen}\flat}[\x]%
    \StrSubstitute{\x}{\sharp}{\hspace{\sklen}\sharp}[\x]%
    \x%
  }%
  }%
}

% Chorus numbers: if there's a dash in the argument, everything to its right
% will be subscripted, if not, the whole thing will be in lining numerals.
% Ex: \cnum{1B} just gives "1B", but \cnum{1A-1} will give 1A\subscript{1},
% also with lining numerals.
\newcommand{\cnum}[1]{%
  {%
    \noexpandarg%
    \liningNums%
    \StrBefore{#1}{-}[\chorus]%
    \StrBehind{#1}{-}[\sec]%
    \expandarg%
    \IfStrEq{\chorus}{}{#1}{\chorus\tsub{\sec}}%
  }%
}

% chord-scale objects/transformations
\newcommand{\scalepair}[2]{%
  \mbox{\ensuremath{\langle}#1, #2\ensuremath{\rangle}}%
}
\newcommand{\cst}[3]{%
  \mbox{\ensuremath{\langle}\h{#1}, #2, #3\ensuremath{\rangle}}%
}
\newcommand{\rtrans}[3]{%
  \mbox{\ensuremath{R\langle}#1, #2, #3\ensuremath{\rangle}}%
}

% text shortcuts
\newcommand{\tf}{\mbox{ii--V}\xspace}
\newcommand{\tfo}{\mbox{ii--V--I}\xspace}
\newcommand{\tfmo}{\mbox{ii--V--i}\xspace}
\newcommand{\tft}{TF\tsub{T}\xspace}
\newcommand{\tfmt}{tf\tsub{T}\xspace}
\newcommand{\slideS}{\abbrev{SLIDE}\textsubscript{7}\xspace}
\newcommand{\tsub}{\textsubscript}
\newcommand{\tsup}{\textsuperscript}
\newcommand{\rightparen}{)}
\newcommand{\ivls}{\abbrev{IVLS}\xspace}
\newcommand{\gis}{\abbrev{GIS}\xspace}
\newcommand{\strans}{\abbrev{STRANS}\xspace}
\newcommand{\ii}{\mbox{ii\ensuremath{^7}}\xspace}
\newcommand{\V}{\mbox{V\ensuremath{^7}}\xspace}
\newcommand{\I}{\mbox{I\ensuremath{^7}}\xspace}
\newcommand{\tuneitem}[1]{\vspace{1em}\noindent#1\vspace{0.5em}}

% uppercase small caps
\newcommand{\abbrev}[1]{{\abbrevSC #1}}
\newcommand{\lcc}{\emph{LCC}\xspace}

% math shortcuts
\newcommand{\lra}{\longrightarrow}
\newcommand{\TFarrow}{\ensuremath{\xrightarrow{\mathrm{TF}\,}}}
\newcommand{\TFTarrow}{\ensuremath{\xrightarrow{\mathrm{TF}_\mathrm{T}\,}}}
\newcommand{\ECarrow}{\ensuremath{\xrightarrow{\mathrm{EC}\,}}}
\newcommand{\ECCarrow}{\ensuremath{\xrightarrow{\mathrm{EC}_\mathrm{C}\,}}}
\newcommand{\CSarrow}{\ensuremath{\xrightarrow{\mathrm{CS}\,}}}
\newcommand{\intZ}{\ensuremath{\mathbb{Z}}}
\newcommand{\la}{\ensuremath{\langle}\xspace}
\newcommand{\ra}{\ensuremath{\rangle}\xspace}

\newcommand{\Smin}{\ensuremath{S_{\mathrm{min}}}\xspace}
\newcommand{\Sdom}{\ensuremath{S_{\mathrm{dom}}}\xspace}
\newcommand{\Smaj}{\ensuremath{S_{\mathrm{maj}}}\xspace}
\newcommand{\SmM}{\ensuremath{S_{\mathrm{mM7}}}\xspace}

%% end mjmdiss.sty %%
